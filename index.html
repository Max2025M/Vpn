<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Kokoro TTS</title>
<style>
body{font-family:Arial,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:#f5f5f5;margin:0}
.container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);width:90%;max-width:500px;text-align:center}
textarea{width:100%;height:100px;margin:10px 0;border-radius:8px;border:1px solid #ccc;padding:10px;font-size:1em;resize:none}
select,button{padding:10px;border-radius:8px;border:1px solid #ccc;margin:5px;width:45%;cursor:pointer;font-size:1em}
button{background:#007bff;color:#fff;width:95%}
progress{width:100%;height:8px;margin-top:10px;display:none}
#popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center}
#popup .content{background:#fff;padding:20px;border-radius:12px;text-align:center;width:90%;max-width:400px}
#popup audio{width:100%;margin-top:10px}
#popup button{background:#28a745;color:white;margin-top:10px}
</style>
</head>
<body>
<div class="container">
<h2>Kokoro TTS - Texto para Áudio</h2>
<textarea id="text" placeholder="Digite o texto"></textarea>
<select id="voice"></select>
<select id="lang"><option value="pt">Português</option><option value="en">English</option></select>
<button id="generateBtn">Gerar Áudio</button>
<progress id="progressBar" value="0" max="100"></progress>
</div>

<div id="popup">
<div class="content">
<h3>Áudio Gerado</h3>
<audio id="audioPlayer" controls></audio>
<a id="downloadBtn" href="#" download="audio.mp3"><button>⬇️ Baixar</button></a>
<br>
<button onclick="document.getElementById('popup').style.display='none'">Fechar</button>
</div>
</div>

<script>
const voiceSelect = document.getElementById('voice');
const textArea = document.getElementById('text');
const generateBtn = document.getElementById('generateBtn');
const progressBar = document.getElementById('progressBar');
const popup = document.getElementById('popup');
const audioPlayer = document.getElementById('audioPlayer');
const downloadBtn = document.getElementById('downloadBtn');
const langSelect = document.getElementById('lang');

async function loadVoices(){
  try{
    const res = await fetch('/voices');
    const data = await res.json();
    (data.voices||[]).forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.id;
      opt.textContent=v.name;
      voiceSelect.appendChild(opt);
    });
  }catch(e){alert('Erro ao carregar locutores')}
}
loadVoices();

generateBtn.addEventListener('click', async()=>{
  const text=textArea.value.trim();
  const voice=voiceSelect.value;
  const language=langSelect.value;
  if(!text||!voice) return alert('Digite texto e selecione locutor');
  progressBar.style.display='block';
  progressBar.value=0;

  const res=await fetch('/generate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({text,voice,language})
  });
  const {id} = await res.json();

  const evtSource = new EventSource(`/progress/${id}`);
  evtSource.onmessage = e=>{
    progressBar.value = Math.min(progressBar.value+5,100);
  };
  evtSource.addEventListener('finished', e=>{
    const data = JSON.parse(e.data);
    audioPlayer.src = data.url;
    downloadBtn.href = data.url;
    popup.style.display='flex';
    progressBar.style.display='none';
    evtSource.close();
  });
});
</script>
</body>
</html>
